{% extends "dashboard/base_vertical.html" %}
{% block title %}{{ competition.name }} – Bet Prediction{% endblock %}

{% block content %}
<p style="margin-bottom:1rem;">
  <a href="{% url 'api_football:competition_list' %}" style="color:#8b949e;">← Competitions</a>
  {% if country_slug %}
  · <a href="{% url 'api_football:country_detail' country_slug %}" style="color:#8b949e;">{{ competition.country }}</a>
  {% endif %}
  · <a href="{% url 'api_football:competition_delete' competition.pk %}" style="color:#f85149;">Delete league</a>
</p>

<h1>{{ competition.name }}</h1>
<p style="color:#6e7681; font-size:0.9rem; margin-top:0.25rem;">Competition id: {{ competition.pk }}, api_id: {{ competition.api_id }}</p>
{% if competition.country or competition.type %}
<p style="color:#8b949e;">{% if competition.country %}{{ competition.country }}{% endif %}{% if competition.type %} · {{ competition.type }}{% endif %}</p>
{% endif %}

<section style="background:#161b22; padding:1rem 1.25rem; border-radius:8px; margin:1rem 0; border:1px solid #30363d;">
  <h2 style="margin:0 0 0.5rem 0; font-size:1rem;">Train ML models (Over/Under 2.5)</h2>
  <p style="font-size:0.9rem; color:#8b949e; margin:0 0 0.75rem 0;">Build dataset from past games (Poisson + xG features), then train Poisson and/or xG classifier. Predictions appear in the tables below.</p>
  <form method="post" action="{% url 'api_football:competition_detail' competition.pk %}" style="display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
    {% csrf_token %}
    <button type="submit" name="action" value="build_dataset">Build dataset</button>
    <button type="submit" name="action" value="train_model">Train Poisson</button>
    <button type="submit" name="action" value="train_xg_model">Train xG</button>
    <button type="submit" name="action" value="build_and_train">Build &amp; train Poisson</button>
    <button type="submit" name="action" value="build_and_train_all">Build &amp; train both</button>
  </form>
  <p style="font-size:0.8rem; color:#6e7681; margin:0.5rem 0 0 0;">Dataset: <code>gemini_dataset_{{ competition.api_id }}.csv</code>. Models: <code>gemini_poisson_{{ competition.api_id }}.json</code>, <code>gemini_xg_{{ competition.api_id }}.pkl</code>.</p>
</section>

<section style="background:#161b22; padding:1rem 1.25rem; border-radius:8px; margin:1rem 0; border:1px solid #30363d;">
  <h2 style="margin:0 0 0.5rem 0; font-size:1rem;">Download this league</h2>
  <p style="font-size:0.9rem; color:#8b949e; margin:0 0 0.5rem 0;">Fetch teams and fixtures for the chosen season (uses API requests). Only this league is downloaded.</p>
  <form method="post" action="{% url 'api_football:competition_detail' competition.pk %}" style="display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
    {% csrf_token %}
    <input type="hidden" name="action" value="download_league">
    <label>Season year(s): <input type="text" name="years" value="{{ season_param|default:'' }}" placeholder="e.g. 2024 or 2023,2024" style="width:10rem; background:#0d1117; border:1px solid #30363d; color:#e6edf3; padding:0.35rem;"></label>
    <button type="submit">Download teams &amp; fixtures</button>
  </form>
</section>

{% if seasons %}
<p style="margin-bottom:1rem;">
  <strong>Season:</strong>
  <a href="{% url 'api_football:competition_detail' competition.pk %}" style="margin-left:0.35rem; color:{% if not season_param %}#58a6ff{% else %}#8b949e{% endif %};">All</a>
  {% for s in seasons %}
  · <a href="?season={{ s }}" style="color:{% if season_param == s %}#58a6ff{% else %}#8b949e{% endif %};">{{ s }}</a>
  {% endfor %}
</p>
{% endif %}

<h2 style="font-size:1.1rem; margin-top:1.5rem;">Upcoming fixtures</h2>
{% if upcoming %}
<table style="width:100%; border-collapse:collapse;">
  <thead>
    <tr style="border-bottom:1px solid #30363d;">
      <th style="text-align:left; padding:0.5rem 0.5rem 0.5rem 0;">Date</th>
      <th style="text-align:left; padding:0.5rem;">Home</th>
      <th style="text-align:center; padding:0.5rem;">Score</th>
      <th style="text-align:left; padding:0.5rem;">Away</th>
      {% if game_ml_odds %}<th style="text-align:center; padding:0.5rem;">Poisson Over 2.5</th><th style="text-align:center; padding:0.5rem;">xG Over 2.5</th>{% endif %}
    </tr>
  </thead>
  <tbody>
    {% for g, ml in upcoming_with_ml %}
    <tr style="border-bottom:1px solid #21262d;">
      <td style="padding:0.5rem 0.5rem 0.5rem 0; color:#8b949e;">{{ g.kickoff|date:"Y-m-d H:i" }}</td>
      <td style="padding:0.5rem;">{{ g.home_team.name }}</td>
      <td style="text-align:center; padding:0.5rem;">{{ g.score_display }}</td>
      <td style="padding:0.5rem;">{{ g.away_team.name }}</td>
      {% if game_ml_odds %}
      <td style="text-align:center; padding:0.5rem;">{% if ml and ml.ml_over_pct is not None %}{{ ml.ml_over_pct }}%{% else %}—{% endif %}</td>
      <td style="text-align:center; padding:0.5rem;">{% if ml and ml.xg_over_pct is not None %}{{ ml.xg_over_pct }}%{% else %}—{% endif %}</td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>
{% if upcoming_paginator.num_pages > 1 %}
<p style="margin-top:0.5rem; font-size:0.9rem;">
  {% if upcoming_page.has_previous %}
  <a href="?{% if season_param %}season={{ season_param }}&{% endif %}upcoming_page={{ upcoming_page.previous_page_number }}{% if past_page.number > 1 %}&past_page={{ past_page.number }}{% endif %}" style="color:#58a6ff;">← Previous</a>
  {% endif %}
  <span style="color:#8b949e;"> Page {{ upcoming_page.number }} of {{ upcoming_paginator.num_pages }}</span>
  {% if upcoming_page.has_next %}
  <a href="?{% if season_param %}season={{ season_param }}&{% endif %}upcoming_page={{ upcoming_page.next_page_number }}{% if past_page.number > 1 %}&past_page={{ past_page.number }}{% endif %}" style="color:#58a6ff;">Next →</a>
  {% endif %}
</p>
{% endif %}
{% else %}
<p style="color:#8b949e;">No upcoming fixtures.</p>
{% endif %}

<h2 style="font-size:1.1rem; margin-top:1.5rem;">Past results</h2>
{% if ml_accuracy %}
<p style="font-size:0.95rem; color:#8b949e; margin:0 0 0.5rem 0;">ML Over 2.5 accuracy: <strong style="color:#3fb950;">{{ ml_accuracy.correct }}</strong> / {{ ml_accuracy.total }} (<strong>{{ ml_accuracy.pct }}%</strong> correct). Max missed in a row: <strong>{{ ml_accuracy.max_missed_row }}</strong></p>
{% endif %}
{% if past %}
<table style="width:100%; border-collapse:collapse;">
  <thead>
    <tr style="border-bottom:1px solid #30363d;">
      <th style="text-align:left; padding:0.5rem 0.5rem 0.5rem 0;">Date</th>
      <th style="text-align:left; padding:0.5rem;">Home</th>
      <th style="text-align:center; padding:0.5rem;">Score</th>
      <th style="text-align:left; padding:0.5rem;">Away</th>
      {% if game_ml_odds %}<th style="text-align:center; padding:0.5rem;">Poisson Over 2.5</th><th style="text-align:center; padding:0.5rem;">xG Over 2.5</th>{% endif %}
    </tr>
  </thead>
  <tbody>
    {% for g, ml, ml_correct, xg_correct in past_with_ml %}
    <tr style="border-bottom:1px solid #21262d;">
      <td style="padding:0.5rem 0.5rem 0.5rem 0; color:#8b949e;">{{ g.kickoff|date:"Y-m-d H:i" }}</td>
      <td style="padding:0.5rem;">{{ g.home_team.name }}</td>
      <td style="text-align:center; padding:0.5rem;">
        <a href="{% url 'api_football:game_statistics' g.pk %}" style="color:#58a6ff;">{{ g.score_display }}</a>
      </td>
      <td style="padding:0.5rem;">{{ g.away_team.name }}</td>
      {% if game_ml_odds %}
      <td style="text-align:center; padding:0.5rem;">
        {% if ml and ml.ml_over_pct is not None %}
        <span style="color:{% if ml_correct %}#3fb950{% elif ml_correct == False %}#f85149{% else %}#8b949e{% endif %};">{{ ml.ml_over_pct }}%</span>
        {% else %}—{% endif %}
      </td>
      <td style="text-align:center; padding:0.5rem;">
        {% if ml and ml.xg_over_pct is not None %}
        <span style="color:{% if xg_correct %}#3fb950{% elif xg_correct == False %}#f85149{% else %}#8b949e{% endif %};">{{ ml.xg_over_pct }}%</span>
        {% else %}—{% endif %}
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>
{% if past_paginator.num_pages > 1 %}
<p style="margin-top:0.5rem; font-size:0.9rem;">
  {% if past_page.has_previous %}
  <a href="?{% if season_param %}season={{ season_param }}&{% endif %}{% if upcoming_page.number > 1 %}upcoming_page={{ upcoming_page.number }}&{% endif %}past_page={{ past_page.previous_page_number }}" style="color:#58a6ff;">← Previous</a>
  {% endif %}
  <span style="color:#8b949e;"> Page {{ past_page.number }} of {{ past_paginator.num_pages }}</span>
  {% if past_page.has_next %}
  <a href="?{% if season_param %}season={{ season_param }}&{% endif %}{% if upcoming_page.number > 1 %}upcoming_page={{ upcoming_page.number }}&{% endif %}past_page={{ past_page.next_page_number }}" style="color:#58a6ff;">Next →</a>
  {% endif %}
</p>
{% endif %}
{% else %}
<p style="color:#8b949e;">No past fixtures.</p>
{% endif %}
{% endblock %}
